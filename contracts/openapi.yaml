openapi: "3.0.3"
info:
  title: HookLine API
  description: |
    HookLine — OSS webhook delivery service.

    Authenticate using a Bearer token in the `Authorization` header:
    ```
    Authorization: Bearer <api-key>
    ```

    Webhook deliveries sent by HookLine include:
    - `x-gp-timestamp`: Unix timestamp in milliseconds
    - `x-gp-signature`: `v1=<hex(hmac_sha256(secret, "{timestamp}.{body}"))>`
  version: "0.2.0"
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:8080
    description: Local development

security:
  - BearerAuth: []

tags:
  - name: Events
  - name: Endpoints
  - name: Subscriptions
  - name: Deliveries
  - name: DLQ
  - name: Replay
  - name: Stream
  - name: WebSocket
  - name: Presence
  - name: Tenants
  - name: Billing
  - name: AdminBilling
  - name: DevInbox
  - name: System

paths:
  /healthz:
    get:
      tags: [System]
      summary: Liveness probe
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"

  /readyz:
    get:
      tags: [System]
      summary: Readiness probe
      security: []
      responses:
        "200":
          description: Ready
        "503":
          description: Not ready

  /metrics:
    get:
      tags: [System]
      summary: Prometheus metrics
      security: []
      responses:
        "200":
          description: Prometheus text format

  /v1/events:
    post:
      tags: [Events]
      summary: Publish an event
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventInput"
      responses:
        "201":
          description: Event published
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

    get:
      tags: [Events]
      summary: List events
      parameters:
        - name: topic
          in: query
          schema:
            type: string
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      responses:
        "200":
          description: List of events
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"

  /v1/events/{id}:
    get:
      tags: [Events]
      summary: Get event by ID
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Event
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/endpoints:
    post:
      tags: [Endpoints]
      summary: Create a webhook endpoint
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EndpointInput"
      responses:
        "201":
          description: Endpoint created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Endpoint"

    get:
      tags: [Endpoints]
      summary: List endpoints
      responses:
        "200":
          description: List of endpoints
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EndpointList"

  /v1/endpoints/{id}:
    get:
      tags: [Endpoints]
      summary: Get endpoint
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Endpoint
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Endpoint"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [Endpoints]
      summary: Update endpoint fields
      parameters:
        - $ref: "#/components/parameters/Id"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EndpointPatch"
      responses:
        "200":
          description: Endpoint updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Endpoint"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags: [Endpoints]
      summary: Delete endpoint
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "204":
          description: Deleted

  /v1/subscriptions:
    post:
      tags: [Subscriptions]
      summary: Create a subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubscriptionInput"
      responses:
        "201":
          description: Subscription created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Subscription"

    get:
      tags: [Subscriptions]
      summary: List subscriptions
      responses:
        "200":
          description: List of subscriptions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SubscriptionList"

  /v1/subscriptions/{id}:
    delete:
      tags: [Subscriptions]
      summary: Delete subscription
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "204":
          description: Deleted

  /v1/deliveries:
    get:
      tags: [Deliveries]
      summary: List delivery attempts
      parameters:
        - name: event_id
          in: query
          schema:
            type: string
        - name: endpoint_id
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, success, failed]
      responses:
        "200":
          description: List of delivery attempts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeliveryList"

  /v1/deliveries/{id}:
    get:
      tags: [Deliveries]
      summary: Get delivery attempt by ID
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Delivery attempt
          content:
            application/json:
              schema:
                type: object
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/dlq:
    get:
      tags: [DLQ]
      summary: List dead letter queue entries
      responses:
        "200":
          description: DLQ entries
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DLQList"

  /v1/dlq/{id}:
    delete:
      tags: [DLQ]
      summary: Delete a DLQ entry
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "204":
          description: Deleted

  /v1/dlq/{id}/requeue:
    post:
      tags: [DLQ]
      summary: Requeue a DLQ entry
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Requeued

  /v1/replay:
    post:
      tags: [Replay]
      summary: Replay events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: |
                Targeted replay supports `event_id` (optionally with `endpoint_id`).
                Batch replay supports filters: `from_ms`, `to_ms`, `topic`, `endpoint_id`, `mode`, `limit`.
              properties:
                event_id:
                  type: string
                endpoint_id:
                  type: string
                  description: Optional endpoint filter for targeted replay
                from_ms:
                  type: integer
                to_ms:
                  type: integer
                topic:
                  type: string
                mode:
                  type: string
                  enum: [all, failed_only]
                limit:
                  type: integer
      responses:
        "200":
          description: Replay scheduled
          content:
            application/json:
              schema:
                type: object
                properties:
                  replay_id:
                    type: string
                  replayed:
                    type: integer
                  scheduled:
                    type: integer
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        event_id:
                          type: string
                        job_ids:
                          type: array
                          items:
                            type: string
                        error:
                          type: string

  /v1/replay/{id}:
    get:
      tags: [Replay]
      summary: Get replay status by ID
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Replay status
          content:
            application/json:
              schema:
                type: object
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/stream:
    get:
      tags: [Stream]
      summary: SSE stream of events
      parameters:
        - name: topic
          in: query
          description: Topic pattern (e.g. orders.*)
          schema:
            type: string
            default: "#"
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string

  /v1/ws:
    get:
      tags: [WebSocket]
      summary: Open a bidirectional WebSocket connection
      description: |
        Upgrades the HTTP connection to WebSocket. Authenticate via the `token` query
        parameter (API key). After connecting, send JSON frames:

        - `{"type":"subscribe","topic":"orders.*"}` — subscribe to a topic pattern
        - `{"type":"unsubscribe","topic":"orders.*"}` — unsubscribe
        - `{"type":"publish","topic":"orders.created","payload":{}}` — publish an event
        - `{"type":"mark_read","event_id":"evt_xxx"}` — acknowledge an event

        The server pushes `{"type":"event","topic":"...","payload":{}}` and
        `{"type":"presence","topic":"...","data":{}}` frames.
      parameters:
        - name: token
          in: query
          required: true
          description: API key (bearer token)
          schema:
            type: string
        - name: topics
          in: query
          description: Comma-separated list of topic patterns to subscribe to on connect
          schema:
            type: string
      responses:
        "101":
          description: Switching Protocols — WebSocket connection established
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/presence:
    get:
      tags: [Presence]
      summary: List online presence for a topic
      parameters:
        - name: topic
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Presence list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PresenceList"

  /v1/presence/{topic}:
    get:
      tags: [Presence]
      summary: Get presence for a specific topic
      parameters:
        - name: topic
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Presence data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PresenceList"

  /v1/tenants:
    post:
      tags: [Tenants]
      summary: Create a tenant (admin only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TenantInput"
      responses:
        "201":
          description: Tenant created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tenant"
        "401":
          $ref: "#/components/responses/Unauthorized"

    get:
      tags: [Tenants]
      summary: List tenants (admin only)
      responses:
        "200":
          description: List of tenants
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantList"

  /v1/tenants/{id}:
    get:
      tags: [Tenants]
      summary: Get a tenant by ID (admin only)
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Tenant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tenant"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags: [Tenants]
      summary: Delete a tenant (admin only)
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "204":
          description: Deleted

  /v1/tenants/{id}/stats:
    get:
      tags: [Tenants]
      summary: Get tenant usage stats (admin only)
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Tenant stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant_id:
                    type: string
                  event_count:
                    type: integer
                  endpoint_count:
                    type: integer
                  subscription_count:
                    type: integer
                  delivery_count:
                    type: integer
                  dlq_count:
                    type: integer

  /v1/billing/subscription:
    get:
      tags: [Billing]
      summary: Get current subscription plan
      responses:
        "200":
          description: Subscription details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingSubscription"
    post:
      tags: [Billing]
      summary: Create or update subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plan:
                  type: string
      responses:
        "200":
          description: Subscription updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingSubscription"

  /v1/billing/usage:
    get:
      tags: [Billing]
      summary: Get current billing period usage
      responses:
        "200":
          description: Usage summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingUsage"

  /v1/billing/invoices:
    get:
      tags: [Billing]
      summary: List invoices
      responses:
        "200":
          description: Invoice list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Invoice"

  /v1/billing/upgrade:
    post:
      tags: [Billing]
      summary: Request a plan upgrade
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plan:
                  type: string
      responses:
        "200":
          description: Upgrade initiated
          content:
            application/json:
              schema:
                type: object

  /v1/billing/payment-methods:
    get:
      tags: [Billing]
      summary: List payment methods
      responses:
        "200":
          description: Payment methods
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/PaymentMethod"
    post:
      tags: [Billing]
      summary: Add a payment method
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
      responses:
        "201":
          description: Payment method added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentMethod"

  /v1/admin/billing/tenants:
    get:
      tags: [AdminBilling]
      summary: List all tenants with billing info (admin only)
      responses:
        "200":
          description: Tenant billing list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object

  /v1/admin/billing/tenants/{id}/plan:
    put:
      tags: [AdminBilling]
      summary: Set a tenant's plan (admin only)
      parameters:
        - $ref: "#/components/parameters/Id"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plan:
                  type: string
      responses:
        "200":
          description: Plan updated

  /v1/admin/billing/tenants/{id}/trial:
    post:
      tags: [AdminBilling]
      summary: Grant trial period to a tenant (admin only)
      parameters:
        - $ref: "#/components/parameters/Id"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
      responses:
        "200":
          description: Trial granted

  /v1/admin/billing/invoices/{id}/void:
    post:
      tags: [AdminBilling]
      summary: Void an invoice (admin only)
      parameters:
        - $ref: "#/components/parameters/Id"
      responses:
        "200":
          description: Invoice voided

  /v1/dev/inbox:
    post:
      tags: [DevInbox]
      summary: Create a test inbox
      security: []
      responses:
        "201":
          description: Inbox created
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  receive_url:
                    type: string

    get:
      tags: [DevInbox]
      summary: List received messages
      security: []
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object

  /v1/dev/inbox/receive/{token}:
    post:
      tags: [DevInbox]
      summary: Receive a webhook (used as endpoint URL)
      security: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Accepted

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer

  parameters:
    Id:
      name: id
      in: path
      required: true
      schema:
        type: string
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        default: 20
    Offset:
      name: offset
      in: query
      schema:
        type: integer
        default: 0

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  schemas:
    StatusResponse:
      type: object
      properties:
        status:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string

    EventInput:
      type: object
      required: [topic]
      description: |
        Canonical payload field is `payload`.
        `data` is kept as a legacy alias for compatibility.
      properties:
        topic:
          type: string
          example: orders.created
        payload:
          type: object
          additionalProperties: true
        data:
          type: object
          additionalProperties: true
          deprecated: true

    Event:
      allOf:
        - $ref: "#/components/schemas/EventInput"
        - type: object
          properties:
            id:
              type: string
            tenant_id:
              type: string
            created_at:
              type: integer
              description: Unix timestamp (ms)
            job_ids:
              type: array
              items:
                type: string

    EventList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Event"

    EndpointInput:
      type: object
      required: [url]
      properties:
        url:
          type: string
          format: uri
          example: https://example.com/webhooks
        secret:
          type: string
          description: HMAC signing secret
        description:
          type: string

    EndpointPatch:
      type: object
      properties:
        url:
          type: string
          format: uri
        secret:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        timeout_ms:
          type: integer
        max_retries:
          type: integer

    Endpoint:
      allOf:
        - $ref: "#/components/schemas/EndpointInput"
        - type: object
          properties:
            endpoint_id:
              type: string
            tenant_id:
              type: string
            created_at:
              type: integer

    EndpointList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Endpoint"

    SubscriptionInput:
      type: object
      required: [endpoint_id, topic_pattern]
      properties:
        endpoint_id:
          type: string
        topic_pattern:
          type: string
          example: "orders.*"
        description:
          type: string

    Subscription:
      allOf:
        - $ref: "#/components/schemas/SubscriptionInput"
        - type: object
          properties:
            subscription_id:
              type: string
            tenant_id:
              type: string
            created_at:
              type: integer

    SubscriptionList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Subscription"

    DeliveryList:
      type: object
      properties:
        items:
          type: array
          items:
            type: object

    DLQList:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              job_id:
                type: string
              event_id:
                type: string
              endpoint_id:
                type: string
              reason:
                type: string
              attempt_count:
                type: integer

    TenantInput:
      type: object
      properties:
        id:
          type: string
          description: Optional tenant ID (auto-generated if omitted)
        name:
          type: string

    Tenant:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        api_key:
          type: string
          description: Present only on creation response
        created_at:
          type: integer
          description: Unix timestamp (ms)

    TenantList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Tenant"

    PresenceEntry:
      type: object
      properties:
        client_id:
          type: string
        topic:
          type: string
        joined_at:
          type: integer
        metadata:
          type: object
          additionalProperties: true

    PresenceList:
      type: object
      properties:
        topic:
          type: string
        count:
          type: integer
        members:
          type: array
          items:
            $ref: "#/components/schemas/PresenceEntry"

    BillingSubscription:
      type: object
      properties:
        plan:
          type: string
        status:
          type: string
        current_period_start:
          type: integer
        current_period_end:
          type: integer
        trial_end:
          type: integer
          nullable: true

    BillingUsage:
      type: object
      properties:
        period_start:
          type: integer
        period_end:
          type: integer
        events_published:
          type: integer
        deliveries_attempted:
          type: integer
        endpoints_active:
          type: integer

    Invoice:
      type: object
      properties:
        id:
          type: string
        amount:
          type: integer
          description: Amount in cents
        currency:
          type: string
        status:
          type: string
          enum: [draft, open, paid, void, uncollectible]
        created_at:
          type: integer
        period_start:
          type: integer
        period_end:
          type: integer

    PaymentMethod:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        last4:
          type: string
        brand:
          type: string
        is_default:
          type: boolean
