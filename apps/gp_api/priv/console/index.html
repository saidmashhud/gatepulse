<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GatePulse Console</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--sidebar:#1a1d27;--border:#2d3142;--text:#e0e0e0;
  --muted:#6c73a0;--accent:#6c63ff;--card:#1a1d27;
  --ok-bg:#1a3a2a;--ok:#4caf7d;--fail-bg:#3a1a1a;--fail:#f47070;
  --warn-bg:#2a2a1a;--warn:#c8b870;--surface:#252a3a;
}
@media(prefers-color-scheme:light){
  :root{--bg:#f5f6fa;--sidebar:#fff;--border:#dde1f0;--text:#1a1d27;
    --muted:#6c73a0;--accent:#6c63ff;--card:#fff;--surface:#eef0f8;
    --ok-bg:#e6f7ee;--fail-bg:#fde8e8;--warn-bg:#fef9e7}
}
body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}
#sidebar{width:196px;background:var(--sidebar);border-right:1px solid var(--border);padding:0;flex-shrink:0;display:flex;flex-direction:column}
#sidebar-brand{color:var(--accent);padding:18px 20px 14px;font-size:16px;font-weight:700;border-bottom:1px solid var(--border)}
.nav-item{padding:10px 20px;cursor:pointer;font-size:13px;color:var(--muted);transition:all .15s;border-left:3px solid transparent}
.nav-item:hover{background:var(--surface);color:var(--text)}
.nav-item.active{background:var(--surface);color:var(--text);border-left-color:var(--accent)}
#sidebar-footer{margin-top:auto;padding:12px 20px;font-size:11px;color:var(--muted);border-top:1px solid var(--border)}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#topbar{background:var(--sidebar);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
#topbar .key-wrap{position:relative;display:flex;align-items:center}
#topbar input[type=password],#topbar input[type=text]{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:6px 30px 6px 10px;font-size:13px;width:260px}
.eye-btn{position:absolute;right:8px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0}
#topbar button{background:var(--accent);border:none;color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px}
#topbar button.sec{background:var(--surface);border:1px solid var(--border);color:var(--text)}
#status{font-size:12px;margin-left:4px}
#content{flex:1;overflow-y:auto;padding:20px}
.panel{display:none}.panel.active{display:block}
h3{color:var(--accent);margin-bottom:16px;font-size:15px}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:8px 12px;background:var(--card);color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle}
tr:hover td{background:var(--surface)}
.badge{padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;white-space:nowrap}
.badge.ok{background:var(--ok-bg);color:var(--ok)}
.badge.fail{background:var(--fail-bg);color:var(--fail)}
.badge.pending,.badge.retrying{background:var(--warn-bg);color:var(--warn)}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px}
.stat-card .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.stat-card .value{font-size:26px;font-weight:700;color:var(--accent)}
.form-row{display:flex;gap:10px;margin-bottom:14px;align-items:flex-end;flex-wrap:wrap}
.form-row label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
.form-row input,.form-row select{background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:7px 10px;font-size:13px}
.btn-sm{background:var(--accent);border:none;color:#fff;padding:7px 14px;border-radius:6px;cursor:pointer;font-size:13px}
.btn-sec{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:7px 14px;border-radius:6px;cursor:pointer;font-size:13px}
.btn-danger{background:#7a2020;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px}
.btn-warn{background:#7a5c10;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px}
.btn-link{background:none;border:none;color:var(--accent);cursor:pointer;font-size:12px;padding:2px 6px;text-decoration:underline}
#stream-feed{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:12px;height:420px;overflow-y:auto;font-family:monospace}
.stream-event{border-bottom:1px solid var(--border);padding:6px 0;color:var(--text)}
.stream-topic{color:var(--accent);font-weight:600}
pre.json{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;font-size:12px;overflow-x:auto;white-space:pre-wrap;word-break:break-all;max-height:400px;overflow-y:auto;margin-top:8px}
.mono{font-family:monospace;font-size:11px}
.truncate{max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
/* Detail panel */
#detail-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:100;align-items:flex-start;justify-content:flex-end}
#detail-overlay.open{display:flex}
#detail-panel{width:min(640px,100vw);height:100vh;background:var(--sidebar);border-left:1px solid var(--border);overflow-y:auto;padding:24px;animation:slideIn .2s ease}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
#detail-panel h4{color:var(--accent);margin-bottom:4px;font-size:14px}
#detail-panel .detail-row{margin-bottom:12px}
#detail-panel .detail-label{font-size:11px;color:var(--muted);margin-bottom:4px}
#detail-close{float:right;background:none;border:none;color:var(--muted);cursor:pointer;font-size:20px;line-height:1}
/* Onboarding */
.onboarding{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:32px;max-width:640px;margin:0 auto}
.onboarding h2{color:var(--accent);margin-bottom:10px}
.onboarding p{color:var(--muted);font-size:14px;margin-bottom:20px;line-height:1.6}
.onboarding pre{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:14px;font-size:12px;margin-bottom:20px;white-space:pre-wrap}
.onboarding .actions{display:flex;gap:10px;flex-wrap:wrap}
/* Inline test result */
.test-result{margin-top:8px;padding:10px;border-radius:6px;font-size:12px;font-family:monospace}
.test-result.ok{background:var(--ok-bg);color:var(--ok)}
.test-result.fail{background:var(--fail-bg);color:var(--fail)}
/* Mobile */
@media(max-width:600px){
  #sidebar{width:100%;height:auto;flex-direction:row;border-right:none;border-bottom:1px solid var(--border);padding:0}
  #sidebar-brand{padding:12px 16px}
  .nav-item{padding:12px 14px;border-left:none;border-bottom:3px solid transparent}
  .nav-item.active{border-bottom-color:var(--accent);border-left-color:transparent}
  body{flex-direction:column}
  #detail-panel{width:100vw}
}
</style>
</head>
<body>
<div id="sidebar">
  <div id="sidebar-brand">âš¡ GatePulse</div>
  <div class="nav-item active" data-panel="dashboard">Dashboard</div>
  <div class="nav-item" data-panel="events">Events</div>
  <div class="nav-item" data-panel="endpoints">Endpoints</div>
  <div class="nav-item" data-panel="subscriptions">Subscriptions</div>
  <div class="nav-item" data-panel="deliveries">Deliveries</div>
  <div class="nav-item" data-panel="dlq">DLQ</div>
  <div class="nav-item" data-panel="stream">Live Stream</div>
  <div id="sidebar-footer">GatePulse Console</div>
</div>
<div id="main">
  <div id="topbar">
    <div class="key-wrap">
      <input type="password" id="apiKey" placeholder="API Key" oninput="saveKey()">
      <button class="eye-btn" onclick="toggleKeyVis()" title="Show/hide">ğŸ‘</button>
    </div>
    <button onclick="refreshCurrent()">Refresh</button>
    <button class="sec" onclick="triggerCompact()">Compact</button>
    <span id="status"></span>
  </div>
  <div id="content">

    <!-- Dashboard -->
    <div class="panel active" id="panel-dashboard">
      <h3>Dashboard</h3>
      <div class="stat-grid">
        <div class="stat-card"><div class="label">Pending Jobs</div><div class="value" id="stat-pending">-</div></div>
        <div class="stat-card"><div class="label">In-Flight</div><div class="value" id="stat-inflight">-</div></div>
        <div class="stat-card"><div class="label">Last Compaction</div><div class="value" id="stat-compact" style="font-size:14px">-</div></div>
        <div class="stat-card"><div class="label">Segments Deleted</div><div class="value" id="stat-segs">-</div></div>
      </div>
      <div id="onboarding-card" style="display:none"></div>
    </div>

    <!-- Events -->
    <div class="panel" id="panel-events">
      <h3>Events</h3>
      <div class="form-row">
        <div><label>Topic filter</label><input type="text" id="ev-topic" placeholder="e.g. orders.*" style="width:200px"></div>
        <div><label>From</label><input type="datetime-local" id="ev-from" style="width:180px"></div>
        <div><label>To</label><input type="datetime-local" id="ev-to" style="width:180px"></div>
        <div><label>Limit</label><input type="number" id="ev-limit" value="50" style="width:70px"></div>
        <button class="btn-sm" onclick="loadEvents()">Load</button>
      </div>
      <table><thead><tr><th>Topic</th><th>Event ID</th><th>Created At</th><th></th></tr></thead>
      <tbody id="ev-table"></tbody></table>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn-sec" id="ev-prev" onclick="evPage(-1)" style="display:none">â† Prev</button>
        <button class="btn-sec" id="ev-next" onclick="evPage(1)" style="display:none">Next â†’</button>
      </div>
    </div>

    <!-- Endpoints -->
    <div class="panel" id="panel-endpoints">
      <h3>Endpoints</h3>
      <div class="form-row">
        <div><label>URL</label><input type="text" id="ep-url" placeholder="https://example.com/webhook" style="width:280px"></div>
        <div><label>Name</label><input type="text" id="ep-name" placeholder="My endpoint" style="width:160px"></div>
        <div><label>Secret</label><input type="text" id="ep-secret" placeholder="(optional)" style="width:160px"></div>
        <button class="btn-sm" onclick="createEndpoint()">Create</button>
      </div>
      <table><thead><tr><th>Name</th><th>URL</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="ep-table"></tbody></table>
      <div id="ep-test-result"></div>
    </div>

    <!-- Subscriptions -->
    <div class="panel" id="panel-subscriptions">
      <h3>Subscriptions</h3>
      <div class="form-row">
        <div><label>Endpoint ID</label><input type="text" id="sub-ep" placeholder="endpoint_id" style="width:260px"></div>
        <div><label>Topic Pattern</label><input type="text" id="sub-topic" value="#" style="width:160px"></div>
        <button class="btn-sm" onclick="createSubscription()">Create</button>
      </div>
      <table><thead><tr><th>ID</th><th>Endpoint</th><th>Pattern</th><th></th></tr></thead>
      <tbody id="sub-table"></tbody></table>
    </div>

    <!-- Deliveries -->
    <div class="panel" id="panel-deliveries">
      <h3>Deliveries</h3>
      <div class="form-row">
        <div><label>Event ID</label><input type="text" id="del-event" placeholder="filter by event" style="width:220px"></div>
        <div><label>Endpoint ID</label><input type="text" id="del-ep" placeholder="filter by endpoint" style="width:220px"></div>
        <div><label>Limit</label><input type="number" id="del-limit" value="50" style="width:70px"></div>
        <button class="btn-sm" onclick="loadDeliveries()">Load</button>
      </div>
      <table><thead><tr><th>Endpoint</th><th>Attempt</th><th>Status</th><th>HTTP</th><th>Latency</th><th>Time</th><th></th></tr></thead>
      <tbody id="del-table"></tbody></table>
    </div>

    <!-- DLQ -->
    <div class="panel" id="panel-dlq">
      <h3>Dead Letter Queue</h3>
      <div class="form-row" style="justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn-sm" onclick="loadDlq()">Refresh</button>
          <button class="btn-warn" onclick="batchRequeue()">Requeue Selected</button>
          <button class="btn-danger" onclick="batchDelete()">Delete Selected</button>
        </div>
      </div>
      <table><thead><tr>
        <th><input type="checkbox" id="dlq-all" onclick="dlqToggleAll(this)"></th>
        <th>Event ID</th><th>Endpoint</th><th>Reason</th><th>Attempts</th><th>Created</th><th>Actions</th>
      </tr></thead>
      <tbody id="dlq-table"></tbody></table>
    </div>

    <!-- Stream -->
    <div class="panel" id="panel-stream">
      <h3>Live SSE Stream</h3>
      <div class="form-row">
        <div><label>Topic filter</label><input type="text" id="stream-topic" value="#" style="width:200px"></div>
        <button class="btn-sm" onclick="startStream()">Connect</button>
        <button class="btn-sec" onclick="stopStream()">Disconnect</button>
        <button class="btn-sec" id="stream-pause-btn" onclick="toggleStreamPause()">Pause</button>
        <span id="stream-status" style="font-size:12px;color:var(--muted)"></span>
      </div>
      <div id="stream-feed"><div style="color:var(--muted);padding:8px">Press Connect to subscribe to live events</div></div>
      <div style="margin-top:8px;font-size:12px;color:var(--muted)"><span id="stream-count">0</span> events (last 50 kept)</div>
    </div>

  </div>
</div>

<!-- Detail slide-over panel -->
<div id="detail-overlay" onclick="closeDetail(event)">
  <div id="detail-panel">
    <button id="detail-close" onclick="closeDetail()">Ã—</button>
    <div id="detail-content"></div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apiKey = localStorage.getItem('gp_api_key') || '';
let currentPanel = 'dashboard';
let es = null;
let streamPaused = false;
let streamCount = 0;
let evCursor = null;
let evCursorStack = [];
let dlqSelected = new Set();

document.getElementById('apiKey').value = apiKey;

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => showPanel(el.dataset.panel, el));
});

function saveKey() {
  apiKey = document.getElementById('apiKey').value;
  localStorage.setItem('gp_api_key', apiKey);
}

function toggleKeyVis() {
  const inp = document.getElementById('apiKey');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

function setStatus(msg, ok=true) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = ok ? 'var(--ok)' : 'var(--fail)';
  if (ok) setTimeout(() => { if (s.textContent===msg) s.textContent=''; }, 3000);
}

function showPanel(name, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  (el || document.querySelector(`[data-panel="${name}"]`))?.classList.add('active');
  currentPanel = name;
  if (name==='dashboard')     loadStats();
  else if (name==='events')        loadEvents();
  else if (name==='endpoints')     loadEndpoints();
  else if (name==='subscriptions') loadSubscriptions();
  else if (name==='deliveries')    loadDeliveries();
  else if (name==='dlq')           loadDlq();
}

function refreshCurrent() { showPanel(currentPanel); }

// â”€â”€ API helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hdr() { return {'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'}; }

async function api(method, path, body) {
  try {
    const r = await fetch(path, {method, headers:hdr(), body:body?JSON.stringify(body):undefined});
    const ct = r.headers.get('content-type')||'';
    const d = ct.includes('json') ? await r.json() : {};
    if (!r.ok) setStatus((d.message||d.error||'HTTP '+r.status), false);
    return [r.ok, d, r.status];
  } catch(e) { setStatus(e.message, false); return [false, {}, 0]; }
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  const [ok, d] = await api('GET', '/v1/admin/stats');
  if (!ok) return;
  document.getElementById('stat-pending').textContent  = d.queue?.pending ?? '-';
  document.getElementById('stat-inflight').textContent = d.queue?.inflight ?? '-';
  document.getElementById('stat-segs').textContent     = d.compaction?.segments_deleted ?? '-';
  const ts = d.compaction?.last_run_at;
  document.getElementById('stat-compact').textContent  = ts && ts>0 ? new Date(ts).toLocaleString() : 'Never';
  checkOnboarding();
}

async function checkOnboarding() {
  const card = document.getElementById('onboarding-card');
  const [ok, d] = await api('GET', '/v1/events?limit=1');
  if (!ok) { card.style.display='none'; return; }
  const hasEvents = (d.items||[]).length > 0;
  if (hasEvents) { card.style.display='none'; return; }
  const key = apiKey || 'dev-secret';
  card.style.display = 'block';
  card.innerHTML = `
    <div class="onboarding">
      <h2>ğŸ‘‹ Welcome to GatePulse!</h2>
      <p>No events yet. Publish your first event to see the system in action:</p>
      <pre>curl -X POST ${location.origin}/v1/events \\
  -H "Authorization: Bearer ${key}" \\
  -H "Content-Type: application/json" \\
  -d '{"topic":"hello.world","payload":{"msg":"it works"}}'</pre>
      <div class="actions">
        <button class="btn-sm" onclick="publishTestEvent()">Publish Test Event</button>
        <button class="btn-sec" onclick="showPanel('events')">Go to Events</button>
      </div>
      <div id="test-event-result" style="margin-top:12px"></div>
    </div>`;
}

async function publishTestEvent() {
  const [ok, d] = await api('POST', '/v1/events', {
    topic: 'hello.world',
    payload: {msg: 'it works', ts: Date.now()}
  });
  const el = document.getElementById('test-event-result');
  if (ok) {
    el.innerHTML = `<div class="test-result ok">âœ“ Event published: ${d.id||d.event_id||''}</div>`;
    setTimeout(() => { loadStats(); showPanel('events'); }, 1200);
  } else {
    el.innerHTML = `<div class="test-result fail">âœ— Failed to publish</div>`;
  }
}

async function triggerCompact() {
  const [ok] = await api('POST', '/v1/admin/compact');
  if (ok) setStatus('Compaction triggered');
}

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let evNextCursor = null;

async function loadEvents(cursor) {
  const limit  = document.getElementById('ev-limit').value || 50;
  const topic  = document.getElementById('ev-topic').value;
  const fromEl = document.getElementById('ev-from').value;
  const toEl   = document.getElementById('ev-to').value;
  let qs = '?limit='+limit;
  if (topic) qs += '&topic='+encodeURIComponent(topic);
  if (fromEl) qs += '&from_ms='+new Date(fromEl).getTime();
  if (toEl)   qs += '&to_ms='+new Date(toEl).getTime();
  if (cursor) qs += '&cursor='+encodeURIComponent(cursor);

  const [ok, d] = await api('GET', '/v1/events'+qs);
  if (!ok) return;
  evNextCursor = d.next_cursor || null;
  document.getElementById('ev-next').style.display = evNextCursor ? '' : 'none';

  const items = d.items || [];
  document.getElementById('ev-table').innerHTML = items.length
    ? items.map(e => `
        <tr>
          <td>${esc(e.topic||'')}</td>
          <td class="mono truncate" title="${esc(e.id||'')}">â€¦${(e.id||'').slice(-12)}</td>
          <td>${e.created_at ? fmt(e.created_at) : ''}</td>
          <td><button class="btn-link" onclick="showEventDetail('${esc(e.id||'')}')">View</button></td>
        </tr>`).join('')
    : '<tr><td colspan="4" style="color:var(--muted);text-align:center;padding:20px">No events</td></tr>';
}

function evPage(dir) {
  if (dir > 0 && evNextCursor) {
    evCursorStack.push(evNextCursor);
    loadEvents(evNextCursor);
  } else {
    evCursorStack.pop();
    loadEvents(evCursorStack[evCursorStack.length-1]);
  }
  document.getElementById('ev-prev').style.display = evCursorStack.length ? '' : 'none';
}

// â”€â”€ Event detail slide-over â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showEventDetail(id) {
  const dc = document.getElementById('detail-content');
  dc.innerHTML = '<p style="color:var(--muted)">Loadingâ€¦</p>';
  openDetail();

  const [ok, d] = await api('GET', '/v1/events/'+id);
  if (!ok) { dc.innerHTML = '<p style="color:var(--fail)">Failed to load event</p>'; return; }
  const ev = d.event || d;

  // Load deliveries linked to this event
  const [, dd] = await api('GET', '/v1/deliveries?event_id='+id+'&limit=20');
  const attempts = dd.items || [];

  dc.innerHTML = `
    <h4>Event</h4>
    <div class="detail-row">
      <div class="detail-label">ID</div>
      <div class="mono">${esc(ev.id||ev.event_id||'')}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Topic</div>
      <div>${esc(ev.topic||'')}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Created</div>
      <div>${ev.created_at ? fmt(ev.created_at) : ''}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Payload</div>
      <pre class="json">${esc(JSON.stringify(ev.payload||ev, null, 2))}</pre>
    </div>
    <h4 style="margin-top:16px;margin-bottom:8px">Delivery Attempts (${attempts.length})</h4>
    ${attempts.length ? `
      <table><thead><tr><th>Endpoint</th><th>Attempt</th><th>Status</th><th>HTTP</th><th>Latency</th></tr></thead>
      <tbody>${attempts.map(a => `
        <tr>
          <td class="mono truncate">${esc((a.endpoint_id||'').slice(-8))}</td>
          <td>${a.attempt_n||a.attempt||1}</td>
          <td><span class="badge ${badgeClass(a.status)}">${esc(a.status||'')}</span></td>
          <td>${a.http_status||''}</td>
          <td>${a.duration_ms ? a.duration_ms+'ms' : ''}</td>
        </tr>`).join('')}
      </tbody></table>` : '<p style="color:var(--muted);font-size:13px">No delivery attempts yet</p>'}`;
}

// â”€â”€ Delivery detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showDeliveryDetail(id) {
  const dc = document.getElementById('detail-content');
  dc.innerHTML = '<p style="color:var(--muted)">Loadingâ€¦</p>';
  openDetail();

  const [ok, d] = await api('GET', '/v1/deliveries/'+id);
  if (!ok) { dc.innerHTML = '<p style="color:var(--fail)">Failed to load attempt</p>'; return; }
  const a = d.attempt || d;

  let respBody = a.response_body || '';
  if (respBody.length > 4096) respBody = respBody.slice(0, 4096) + '\nâ€¦ (truncated)';

  dc.innerHTML = `
    <h4>Delivery Attempt</h4>
    <div class="detail-row"><div class="detail-label">Attempt ID</div><div class="mono">${esc(a.attempt_id||id)}</div></div>
    <div class="detail-row"><div class="detail-label">Job ID</div><div class="mono">${esc(a.job_id||'')}</div></div>
    <div class="detail-row"><div class="detail-label">Event ID</div><div class="mono">${esc(a.event_id||'')}</div></div>
    <div class="detail-row"><div class="detail-label">Endpoint</div><div class="mono">${esc(a.endpoint_id||'')}</div></div>
    <div class="detail-row"><div class="detail-label">Status</div><div><span class="badge ${badgeClass(a.status)}">${esc(a.status||'')}</span></div></div>
    <div class="detail-row"><div class="detail-label">HTTP Status</div><div>${a.http_status||''}</div></div>
    <div class="detail-row"><div class="detail-label">Latency</div><div>${a.duration_ms ? a.duration_ms+'ms' : ''}</div></div>
    <div class="detail-row"><div class="detail-label">Attempt #</div><div>${a.attempt_n||a.attempt||1}</div></div>
    ${a.error ? `<div class="detail-row"><div class="detail-label">Error</div><div style="color:var(--fail)">${esc(a.error)}</div></div>` : ''}
    ${respBody ? `<div class="detail-row"><div class="detail-label">Response Body (4KB max)</div><pre class="json">${esc(respBody)}</pre></div>` : ''}`;
}

function openDetail() {
  document.getElementById('detail-overlay').classList.add('open');
}

function closeDetail(e) {
  if (e && e.target !== document.getElementById('detail-overlay')) return;
  document.getElementById('detail-overlay').classList.remove('open');
}

// â”€â”€ Endpoints â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEndpoints() {
  const [ok, d] = await api('GET', '/v1/endpoints');
  if (!ok) return;
  const items = d.items || [];
  document.getElementById('ep-table').innerHTML = items.length
    ? items.map(e => `
        <tr>
          <td>${esc(e.name||'')}</td>
          <td class="truncate" title="${esc(e.url||'')}">${esc(e.url||'')}</td>
          <td><span class="badge ${e.enabled===false?'fail':'ok'}">${e.enabled===false?'disabled':'enabled'}</span></td>
          <td style="white-space:nowrap">
            <button class="btn-link" onclick="testEndpoint('${esc(e.endpoint_id||e.id||'')}','${esc(e.url||'')}')">Test</button>
            <button class="btn-danger" style="margin-left:6px" onclick="deleteEndpoint('${esc(e.endpoint_id||e.id||'')}')">Delete</button>
          </td>
        </tr>`).join('')
    : '<tr><td colspan="4" style="color:var(--muted);text-align:center;padding:20px">No endpoints â€” create one above</td></tr>';
}

async function createEndpoint() {
  const url = document.getElementById('ep-url').value;
  const name = document.getElementById('ep-name').value;
  const secret = document.getElementById('ep-secret').value;
  if (!url) { setStatus('URL required', false); return; }
  const body = {url, enabled: true};
  if (name) body.name = name;
  if (secret) body.secret = secret;
  const [ok] = await api('POST', '/v1/endpoints', body);
  if (ok) { setStatus('Endpoint created'); loadEndpoints(); }
}

async function deleteEndpoint(id) {
  if (!confirm('Delete endpoint '+id+'?')) return;
  const [ok] = await api('DELETE', '/v1/endpoints/'+id);
  if (ok) { setStatus('Deleted'); loadEndpoints(); }
}

async function testEndpoint(id, url) {
  const resultEl = document.getElementById('ep-test-result');
  resultEl.innerHTML = '<div style="font-size:12px;color:var(--muted);margin-top:8px">Sending test eventâ€¦</div>';
  const [ok, d] = await api('POST', '/v1/events', {
    topic: 'gatepulse.test',
    payload: {endpoint_id: id, ts: Date.now(), source: 'console-test'}
  });
  if (ok) {
    const evId = d.id || d.event_id || '';
    resultEl.innerHTML = `<div class="test-result ok" style="margin-top:8px">âœ“ Test event sent (id: ${esc(evId)}) â†’ Delivery to ${esc(url)} should appear in Deliveries tab</div>`;
    setTimeout(() => showPanel('deliveries'), 2000);
  } else {
    resultEl.innerHTML = `<div class="test-result fail" style="margin-top:8px">âœ— Failed to send test event</div>`;
  }
}

// â”€â”€ Subscriptions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSubscriptions() {
  const [ok, d] = await api('GET', '/v1/subscriptions');
  if (!ok) return;
  document.getElementById('sub-table').innerHTML = (d.items||[]).map(s => `
    <tr>
      <td class="mono truncate">${esc((s.subscription_id||s.id||'').slice(-12))}</td>
      <td class="mono truncate">${esc((s.endpoint_id||'').slice(-12))}</td>
      <td>${esc(s.topic_pattern||'')}</td>
      <td><button class="btn-danger" onclick="deleteSubscription('${esc(s.subscription_id||s.id||'')}')">Delete</button></td>
    </tr>`).join('') || '<tr><td colspan="4" style="color:var(--muted);text-align:center;padding:20px">No subscriptions</td></tr>';
}

async function createSubscription() {
  const endpoint_id = document.getElementById('sub-ep').value;
  const topic_pattern = document.getElementById('sub-topic').value || '#';
  if (!endpoint_id) { setStatus('Endpoint ID required', false); return; }
  const [ok] = await api('POST', '/v1/subscriptions', {endpoint_id, topic_pattern});
  if (ok) { setStatus('Subscription created'); loadSubscriptions(); }
}

async function deleteSubscription(id) {
  const [ok] = await api('DELETE', '/v1/subscriptions/'+id);
  if (ok) { setStatus('Deleted'); loadSubscriptions(); }
}

// â”€â”€ Deliveries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDeliveries() {
  const limit  = document.getElementById('del-limit').value || 50;
  const evId   = document.getElementById('del-event').value;
  const epId   = document.getElementById('del-ep').value;
  let qs = '?limit='+limit;
  if (evId) qs += '&event_id='+encodeURIComponent(evId);
  if (epId) qs += '&endpoint_id='+encodeURIComponent(epId);
  const [ok, d] = await api('GET', '/v1/deliveries'+qs);
  if (!ok) return;
  const items = d.items || [];
  document.getElementById('del-table').innerHTML = items.length
    ? items.map(a => `
        <tr>
          <td class="mono truncate">${esc((a.endpoint_id||'').slice(-10))}</td>
          <td>${a.attempt_n||a.attempt||1}</td>
          <td><span class="badge ${badgeClass(a.status)}">${esc(a.status||'')}</span></td>
          <td style="color:${httpColor(a.http_status)}">${a.http_status||''}</td>
          <td>${a.duration_ms ? a.duration_ms+'ms' : ''}</td>
          <td style="white-space:nowrap">${a.started_at ? fmt(a.started_at) : ''}</td>
          <td><button class="btn-link" onclick="showDeliveryDetail('${esc(a.attempt_id||'')}')">Detail</button></td>
        </tr>`).join('')
    : '<tr><td colspan="7" style="color:var(--muted);text-align:center;padding:20px">No deliveries</td></tr>';
}

// â”€â”€ DLQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDlq() {
  dlqSelected.clear();
  const [ok, d] = await api('GET', '/v1/dlq');
  if (!ok) return;
  const items = d.items || [];
  document.getElementById('dlq-all').checked = false;
  document.getElementById('dlq-table').innerHTML = items.length
    ? items.map(j => {
        const id = j.job_id||j.id||'';
        return `<tr>
          <td><input type="checkbox" class="dlq-cb" data-id="${esc(id)}" onchange="dlqCheckChange(this)"></td>
          <td class="mono truncate">${esc((j.event_id||'').slice(-12))}</td>
          <td class="mono truncate">${esc((j.endpoint_id||'').slice(-10))}</td>
          <td>${esc(j.reason||'')}</td>
          <td>${j.attempt_count||j.attempt_n||''}</td>
          <td>${j.created_at ? fmt(j.created_at) : ''}</td>
          <td style="white-space:nowrap">
            <button class="btn-warn" style="margin-right:4px" onclick="requeueDlq('${esc(id)}')">Requeue</button>
            <button class="btn-danger" onclick="deleteDlq('${esc(id)}')">Delete</button>
          </td>
        </tr>`;
      }).join('')
    : '<tr><td colspan="7" style="color:var(--muted);text-align:center;padding:20px">DLQ is empty âœ“</td></tr>';
}

function dlqToggleAll(cb) {
  document.querySelectorAll('.dlq-cb').forEach(el => {
    el.checked = cb.checked;
    if (cb.checked) dlqSelected.add(el.dataset.id);
    else dlqSelected.delete(el.dataset.id);
  });
}

function dlqCheckChange(el) {
  if (el.checked) dlqSelected.add(el.dataset.id);
  else dlqSelected.delete(el.dataset.id);
}

async function requeueDlq(id) {
  const [ok] = await api('POST', '/v1/dlq/'+id+'/requeue');
  if (ok) { setStatus('Requeued'); loadDlq(); }
}

async function deleteDlq(id) {
  const [ok] = await api('DELETE', '/v1/dlq/'+id);
  if (ok) { setStatus('Deleted'); loadDlq(); }
}

async function batchRequeue() {
  if (!dlqSelected.size) { setStatus('Select items first', false); return; }
  const ids = [...dlqSelected];
  await Promise.all(ids.map(id => api('POST', '/v1/dlq/'+id+'/requeue')));
  setStatus(`Requeued ${ids.length} job(s)`);
  loadDlq();
}

async function batchDelete() {
  if (!dlqSelected.size) { setStatus('Select items first', false); return; }
  if (!confirm(`Delete ${dlqSelected.size} DLQ job(s)?`)) return;
  const ids = [...dlqSelected];
  await Promise.all(ids.map(id => api('DELETE', '/v1/dlq/'+id)));
  setStatus(`Deleted ${ids.length} job(s)`);
  loadDlq();
}

// â”€â”€ Stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startStream() {
  stopStream();
  streamCount = 0;
  streamPaused = false;
  updatePauseBtn();
  const topic = document.getElementById('stream-topic').value || '#';
  const feed = document.getElementById('stream-feed');
  feed.innerHTML = '<div style="color:var(--muted);padding:8px">Connectingâ€¦</div>';
  const url = '/v1/stream?topic='+encodeURIComponent(topic);
  es = new EventSource(url);
  es.onopen = () => {
    document.getElementById('stream-status').textContent = 'â— Connected';
    document.getElementById('stream-status').style.color = 'var(--ok)';
    feed.innerHTML = '';
  };
  es.onmessage = (e) => {
    if (streamPaused) return;
    try {
      const d = JSON.parse(e.data);
      streamCount++;
      document.getElementById('stream-count').textContent = streamCount;
      const el = document.createElement('div');
      el.className = 'stream-event';
      el.innerHTML = `<span class="stream-topic">${esc(d.topic||'(no topic)')}</span> `+
        `<span style="color:var(--muted);font-size:11px">${new Date().toLocaleTimeString()}</span>`+
        `<pre class="json" style="max-height:120px">${esc(JSON.stringify(d,null,2))}</pre>`;
      feed.insertBefore(el, feed.firstChild);
      while (feed.children.length > 50) feed.removeChild(feed.lastChild);
    } catch(_) {}
  };
  es.onerror = () => {
    document.getElementById('stream-status').textContent = 'â— Disconnected';
    document.getElementById('stream-status').style.color = 'var(--fail)';
  };
}

function stopStream() {
  if (es) { es.close(); es = null; }
  document.getElementById('stream-status').textContent = '';
}

function toggleStreamPause() {
  streamPaused = !streamPaused;
  updatePauseBtn();
}

function updatePauseBtn() {
  document.getElementById('stream-pause-btn').textContent = streamPaused ? 'Resume' : 'Pause';
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(ms) {
  if (!ms) return '';
  const d = new Date(ms);
  return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function badgeClass(s) {
  if (!s) return '';
  if (s === 'success') return 'ok';
  if (s === 'retrying' || s === 'pending') return 'pending';
  return 'fail';
}

function httpColor(code) {
  if (!code) return 'inherit';
  if (code >= 200 && code < 300) return 'var(--ok)';
  if (code >= 500) return 'var(--fail)';
  return 'var(--warn)';
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadStats();
</script>
</body>
</html>
