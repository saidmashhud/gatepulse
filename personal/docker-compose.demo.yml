# docker-compose.demo.yml
#
# Unified demo stack: Mashgate (core) + HookLine + Zist
#
# All services share the "demo-network" so they can reach each other by name.
# Mashgate services are on their native port range (9660-9693).
# Zist gateway is on port 8000 (primary entry point).
# HookLine is on port 8080.
#
# Usage:
#   docker compose -f docker-compose.demo.yml up -d
#   ./zist/scripts/provision-mashgate-dev.sh
#   open http://localhost:8000
#
# Required .env (or environment variables):
#   HOOKLINE_API_KEY   — HL_API_KEY for HookLine (default: dev-secret)
#   MASHGATE_API_KEY   — API key for Zist payments service to call Mashgate
#   MASHGATE_WEBHOOK_SECRET — HMAC secret for webhook signature verification
#   MGID_CLIENT_SECRET — OAuth client secret (set by provision script)
#   SESSION_SECRET     — Session cookie secret for Zist gateway

name: zist-demo

# ─── Shared network ───────────────────────────────────────────────────────────

networks:
  demo-network:
    name: demo_network
    driver: bridge

# ─── Volumes ──────────────────────────────────────────────────────────────────

volumes:
  mashgate_postgres_data:
    name: demo_mashgate_postgres
  mashgate_dragonfly_data:
    name: demo_mashgate_dragonfly
  mashgate_kafka_data:
    name: demo_mashgate_kafka
  hookline_data:
    name: demo_hookline_data
  zist_db_data:
    name: demo_zist_db

# ─── Services ─────────────────────────────────────────────────────────────────

services:

  # ══════════════════════════════════════════════════════════════════════════════
  # MASHGATE INFRASTRUCTURE
  # ══════════════════════════════════════════════════════════════════════════════

  mashgate-postgres:
    image: postgres:15-alpine
    container_name: demo-mashgate-postgres
    environment:
      POSTGRES_DB: payments_dev
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
    volumes:
      - mashgate_postgres_data:/var/lib/postgresql/data
      - ./mashgate/infra/local/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d payments_dev"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - demo-network

  mashgate-dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: demo-mashgate-dragonfly
    volumes:
      - mashgate_dragonfly_data:/data
    ulimits:
      memlock: -1
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - demo-network

  mashgate-kafka:
    image: apache/kafka:3.7.0
    container_name: demo-mashgate-kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@mashgate-kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://mashgate-kafka:29092,PLAINTEXT_HOST://localhost:9677
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      CLUSTER_ID: "DemoMashgateCluster01"
    volumes:
      - mashgate_kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 > /dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - demo-network

  mashgate-envoy:
    image: envoyproxy/envoy-contrib:v1.29-latest
    container_name: demo-mashgate-envoy
    ports:
      - "9661:8080"   # REST API  ← Zist & browser hit this
      - "9662:8081"   # gRPC-Web
    volumes:
      - ./mashgate/infra/local/envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./mashgate/infra/local/envoy/proto:/etc/envoy/proto:ro
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "warn"]
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/127.0.0.1/9901' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - demo-network

  mashgate-auth:
    build:
      context: ./mashgate
      dockerfile: apps/backend/orchestration/auth-service/Dockerfile
    container_name: demo-mashgate-auth
    depends_on:
      mashgate-postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: jdbc:postgresql://mashgate-postgres:5432/payments_dev
      GRPC_PORT: 50052
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
      JWT_ACCESS_TOKEN_EXPIRES_IN: 1h
      JWT_REFRESH_TOKEN_EXPIRES_IN: 30d
      JWT_ISSUER: ${JWT_ISSUER:-auth-service}
    restart: unless-stopped
    networks:
      - demo-network

  mashgate-ledger:
    build:
      context: ./mashgate
      dockerfile: apps/backend/core/ledger-core/Dockerfile
    container_name: demo-mashgate-ledger
    depends_on:
      mashgate-postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://dev:dev@mashgate-postgres:5432/payments_dev
      GRPC_PORT: 50051
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
      JWT_ISSUER: ${JWT_ISSUER:-auth-service}
    restart: unless-stopped
    networks:
      - demo-network

  mashgate-checkout:
    build:
      context: ./mashgate
      dockerfile: apps/backend/orchestration/checkout-service/Dockerfile
    container_name: demo-mashgate-checkout
    depends_on:
      mashgate-postgres:
        condition: service_healthy
    environment:
      GRPC_PORT: 50056
      DATABASE_URL: "jdbc:postgresql://mashgate-postgres:5432/payments_dev"
      DATABASE_USER: dev
      DATABASE_PASSWORD: dev
      CHECKOUT_BASE_URL: http://localhost:9660
      CHECKOUT_EXPIRE_MINUTES: 30
    restart: unless-stopped
    networks:
      - demo-network

  mashgate-webhook-delivery:
    build:
      context: ./mashgate
      dockerfile: apps/backend/orchestration/webhook-delivery/Dockerfile
    container_name: demo-mashgate-webhook-delivery
    depends_on:
      mashgate-postgres:
        condition: service_healthy
      mashgate-kafka:
        condition: service_healthy
    environment:
      GRPC_PORT: 50057
      DATABASE_URL: "jdbc:postgresql://mashgate-postgres:5432/payments_dev"
      DATABASE_USER: dev
      DATABASE_PASSWORD: dev
      KAFKA_BOOTSTRAP_SERVERS: mashgate-kafka:29092
      KAFKA_GROUP_ID: webhook-delivery-group
      WEBHOOK_MAX_RETRY_ATTEMPTS: 5
      HOOKLINE_URL: "http://hookline:8080"
      HOOKLINE_API_KEY: "${HOOKLINE_API_KEY:-dev-secret}"
    restart: unless-stopped
    networks:
      - demo-network

  mashgate-frontend:
    build:
      context: ./mashgate
      dockerfile: apps/frontend/Dockerfile
    container_name: demo-mashgate-frontend
    ports:
      - "9660:80"
    networks:
      - demo-network

  # ══════════════════════════════════════════════════════════════════════════════
  # HOOKLINE
  # ══════════════════════════════════════════════════════════════════════════════

  hookline:
    build:
      context: ./hookline
      dockerfile: Dockerfile
    image: hookline:demo
    container_name: demo-hookline
    ports:
      - "8080:8080"
    volumes:
      - hookline_data:/var/lib/hookline
    environment:
      HL_PORT: "8080"
      HL_LISTEN_ADDR: "0.0.0.0"
      HL_STORE_SOCKET: "/run/hookline/gp_store.sock"
      HL_DATA_DIR: "/var/lib/hookline"
      HL_SINGLE_TENANT: "true"
      HL_API_KEY: "${HOOKLINE_API_KEY:-dev-secret}"
      HL_TENANT_ID: "demo"
      HL_DELIVERY_WORKERS: "8"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - demo-network

  # ══════════════════════════════════════════════════════════════════════════════
  # ZIST
  # ══════════════════════════════════════════════════════════════════════════════

  zist-db:
    image: postgres:16-alpine
    container_name: demo-zist-db
    environment:
      POSTGRES_DB: zist
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
    volumes:
      - zist_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d zist"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - demo-network

  zist-listings:
    build:
      context: ./zist/services/listings
    container_name: demo-zist-listings
    environment:
      LISTINGS_PORT: "8001"
      DATABASE_URL: "postgres://dev:dev@zist-db:5432/zist?sslmode=disable"
    depends_on:
      zist-db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8001/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - demo-network

  zist-bookings:
    build:
      context: ./zist/services/bookings
    container_name: demo-zist-bookings
    environment:
      BOOKINGS_PORT: "8002"
      DATABASE_URL: "postgres://dev:dev@zist-db:5432/zist?sslmode=disable"
    depends_on:
      zist-db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8002/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - demo-network

  zist-payments:
    build:
      context: .
      dockerfile: zist/services/payments/Dockerfile
    container_name: demo-zist-payments
    environment:
      PAYMENTS_PORT: "8003"
      MASHGATE_URL: "http://mashgate-envoy:8080"
      MASHGATE_API_KEY: "${MASHGATE_API_KEY:-}"
      MASHGATE_WEBHOOK_SECRET: "${MASHGATE_WEBHOOK_SECRET:-}"
      BOOKINGS_URL: "http://zist-bookings:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8003/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - demo-network

  zist-web:
    build:
      context: ./zist/apps/web
    container_name: demo-zist-web
    environment:
      PORT: "3000"
      HOST: "0.0.0.0"
      ORIGIN: "http://zist-gateway:8000"
    restart: unless-stopped
    networks:
      - demo-network

  zist-gateway:
    build:
      context: ./zist/services/gateway
    container_name: demo-zist-gateway
    ports:
      - "8000:8000"       # Main entry point → open http://localhost:8000
      - "8443:8443/udp"   # HTTP/3 QUIC
    environment:
      GATEWAY_PORT: "8000"
      GATEWAY_TLS_PORT: "8443"
      LISTINGS_URL: "http://zist-listings:8001"
      BOOKINGS_URL: "http://zist-bookings:8002"
      PAYMENTS_URL: "http://zist-payments:8003"
      WEB_URL: "http://zist-web:3000"
      MGID_URL: "http://mashgate-envoy:8080"
      MGID_CLIENT_ID: "${MGID_CLIENT_ID:-zist-local}"
      MGID_CLIENT_SECRET: "${MGID_CLIENT_SECRET:-}"
      MGID_REDIRECT_URI: "${MGID_REDIRECT_URI:-http://localhost:8000/api/auth/callback}"
      MGID_ADMIN_TOKEN: "${MGID_ADMIN_TOKEN:-}"
      HOOKLINE_URL: "http://hookline:8080"
      HOOKLINE_API_KEY: "${HOOKLINE_API_KEY:-dev-secret}"
      SESSION_SECRET: "${SESSION_SECRET:-demo-session-secret}"
    depends_on:
      - zist-listings
      - zist-bookings
      - zist-payments
      - zist-web
      - hookline
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - demo-network
