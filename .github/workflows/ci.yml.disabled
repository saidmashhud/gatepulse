name: HookLine CI

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Build + lint
  # ──────────────────────────────────────────────────────────────────────────

  build:
    name: Build (Erlang + C) + Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.23'

      - name: Rebar3 cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-rebar3-${{ hashFiles('rebar.lock') }}
          restore-keys: ${{ runner.os }}-rebar3-

      - name: Compile Erlang
        run: rebar3 compile

      - name: Dialyzer (type analysis)
        run: rebar3 dialyzer || true  # advisory in CI, fatal on main via separate job

      - name: Build C daemon
        run: make -C c all

      - name: cppcheck (static analysis)
        run: |
          if command -v cppcheck &>/dev/null; then
            cppcheck --enable=warning,performance --error-exitcode=1 c/src/
          else
            echo "cppcheck not installed — skipping"
          fi

  # ──────────────────────────────────────────────────────────────────────────
  # Erlang unit tests (EUnit)
  # ──────────────────────────────────────────────────────────────────────────

  test-unit:
    name: Unit Tests (EUnit)
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.23'

      - name: Rebar3 cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-rebar3-${{ hashFiles('rebar.lock') }}
          restore-keys: ${{ runner.os }}-rebar3-

      - name: Run EUnit tests
        run: rebar3 eunit --cover

      - name: Coverage report
        run: rebar3 cover --verbose || true

  # ──────────────────────────────────────────────────────────────────────────
  # C unit tests
  # ──────────────────────────────────────────────────────────────────────────

  test-c:
    name: C Unit Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Build and run C tests
        run: make -C c test

  # ──────────────────────────────────────────────────────────────────────────
  # C tests with ASAN + UBSan (only when c/ is changed)
  # ──────────────────────────────────────────────────────────────────────────

  test-c-asan:
    name: C Tests with ASAN + UBSan
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'c/')
    steps:
      - uses: actions/checkout@v4

      - name: Detect c/ changes
        id: changes
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q '^c/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Build with ASAN + UBSan
        if: steps.changes.outputs.changed == 'true' || github.event_name == 'push'
        env:
          CC: clang
          CFLAGS: -fsanitize=address,undefined -g -O1 -fno-omit-frame-pointer
          LDFLAGS: -fsanitize=address,undefined
        run: |
          make -C c clean
          make -C c CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" all test

      - name: Run with leak detection
        if: steps.changes.outputs.changed == 'true' || github.event_name == 'push'
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
          UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
        run: make -C c test

  # ──────────────────────────────────────────────────────────────────────────
  # AFL++ fuzz (60 seconds, only when c/ is changed)
  # ──────────────────────────────────────────────────────────────────────────

  test-c-fuzz:
    name: AFL++ Fuzz (60s)
    runs-on: ubuntu-latest
    needs: [test-c]
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'c/')
    steps:
      - uses: actions/checkout@v4

      - name: Detect c/ changes
        id: changes
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q '^c/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install AFL++
        if: steps.changes.outputs.changed == 'true' || github.event_name == 'push'
        run: |
          sudo apt-get update -q
          sudo apt-get install -y afl++ || \
          (git clone --depth=1 https://github.com/AFLplusplus/AFLplusplus /tmp/afl && \
           make -C /tmp/afl -j$(nproc) && \
           sudo make -C /tmp/afl install)

      - name: Build fuzz target
        if: steps.changes.outputs.changed == 'true' || github.event_name == 'push'
        run: |
          AFL_USE_ASAN=1 afl-clang-fast \
            -fsanitize=address,undefined \
            -g -O1 \
            -o build/fuzz_parser \
            c/fuzz/fuzz_parser.c c/src/*.c \
            -I c/src
        continue-on-error: true

      - name: Create seed corpus
        if: steps.changes.outputs.changed == 'true' || github.event_name == 'push'
        run: |
          mkdir -p c/fuzz/seeds
          # Minimal valid frame seeds
          printf '\x00\x00\x00\x04\x01\x00\x00\x00' > c/fuzz/seeds/empty
          printf '{"id":"x","topic":"orders.created","payload":{}}' > c/fuzz/seeds/valid_event
          printf '\xff\xfe\xfd\xfc' > c/fuzz/seeds/garbage
        continue-on-error: true

      - name: Run AFL++ for 60 seconds
        if: steps.changes.outputs.changed == 'true' || github.event_name == 'push'
        run: |
          timeout 65 afl-fuzz \
            -i c/fuzz/seeds \
            -o /tmp/fuzz_out \
            -t 5000 \
            -- ./build/fuzz_parser @@ || true
        continue-on-error: true

      - name: Check for crashes
        if: steps.changes.outputs.changed == 'true' || github.event_name == 'push'
        run: |
          CRASHES=$(find /tmp/fuzz_out -name "id:*" -path "*/crashes/*" 2>/dev/null | wc -l)
          echo "Crashes found: $CRASHES"
          if [ "$CRASHES" -gt 0 ]; then
            echo "❌ AFL++ found $CRASHES crash(es) — review /tmp/fuzz_out/crashes/"
            exit 1
          fi
          echo "✅ No crashes found"
        continue-on-error: true

  # ──────────────────────────────────────────────────────────────────────────
  # Erlang integration tests (Common Test)
  # ──────────────────────────────────────────────────────────────────────────

  test-integration:
    name: Integration Tests (CT)
    runs-on: ubuntu-latest
    needs: [test-unit]
    timeout-minutes: 10
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: hookline
          POSTGRES_PASSWORD: hookline
          POSTGRES_DB: hookline_test
        ports: ['5432:5432']
        options: --health-cmd pg_isready --health-interval 5s --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.23'

      - name: Rebar3 cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-rebar3-${{ hashFiles('rebar.lock') }}
          restore-keys: ${{ runner.os }}-rebar3-

      - name: Run CT suites
        env:
          DB_HOST: localhost
          DB_PORT: '5432'
          DB_NAME: hookline_test
          DB_USER: hookline
          DB_PASS: hookline
        run: rebar3 ct

  # ──────────────────────────────────────────────────────────────────────────
  # SDK tests (all SDKs)
  # ──────────────────────────────────────────────────────────────────────────

  test-sdk:
    name: SDK Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (TypeScript SDK)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test TypeScript SDK
        run: |
          [ -d sdk/typescript ] && (cd sdk/typescript && npm ci && npm test) || true

      - name: Setup Go (Go SDK)
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Test Go SDK
        run: |
          [ -d sdk/go ] && (cd sdk/go && go test ./...) || true

  # ──────────────────────────────────────────────────────────────────────────
  # Performance baseline (main only)
  # ──────────────────────────────────────────────────────────────────────────

  test-performance:
    name: Performance Baseline (WS fanout)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [test-integration]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.23'

      - name: Start HookLine
        run: rebar3 release && _build/default/rel/hookline/bin/hookline start
        timeout-minutes: 2
        continue-on-error: true

      - name: Run WS fanout load test
        run: |
          [ -f test/ws.sh ] && bash test/ws.sh --subscribers=100 || true
        continue-on-error: true

      - name: Stop HookLine
        if: always()
        run: _build/default/rel/hookline/bin/hookline stop || true
